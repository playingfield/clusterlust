#!/usr/bin/env ansible-playbook
---

- name: Kube config
  hosts: all
  tags: [kube_config]
  tasks:
    - name: Create local config dir
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: .kube
        state: directory
        mode: '0700'

    - name: Fetch kube config from master
      when: ansible_hostname in groups['kube_control_plane']
      become: true
      ansible.builtin.fetch:
        src: /etc/kubernetes/admin.conf
        dest: ~/.kube/config
        mode: '0600'
        flat: true

    - name: Ensure .kube directory exists
      become: false
      ansible.builtin.file:
        path: ~/.kube
        state: directory
        mode: '0700'

    - name: Copy kube config to nodes
      become: false
      ansible.builtin.copy:
        src: ~/.kube/config
        dest: ~/.kube/config
        mode: '0600'
